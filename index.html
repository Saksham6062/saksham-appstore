<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Saksham App Store — Futuristic</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-1:#081226;
    --bg-2:#0f2a43;
    --card:#0e1620aa;
    --glass: rgba(255,255,255,0.06);
    --accent1: #7b61ff;
    --accent2: #00e4ff;
    --muted:#b6c7d9;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#e6f2ff;background: linear-gradient(135deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
  .app {
    max-width:1200px;margin:28px auto;padding:20px;
  }

  /* header */
  header.site-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px}
  .brand {display:flex;align-items:center;gap:12px}
  .logo {
    width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));
    display:flex;align-items:center;justify-content:center;color:#001;text-shadow:0 1px 10px rgba(0,0,0,0.3);font-weight:800;font-size:20px;
  }
  .brand h1{margin:0;font-size:20px;color: #fff}
  .brand p{margin:0;font-size:12px;color:var(--muted)}

  /* actions */
  .actions{display:flex;gap:10px;align-items:center}
  .search-wrap{display:flex;align-items:center;background:rgba(255,255,255,0.03);padding:8px;border-radius:10px;backdrop-filter:blur(6px)}
  .search-wrap input{background:transparent;border:none;outline:none;color:#fff;padding:6px 8px;width:220px}
  .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#001;padding:8px 12px;border-radius:10px;border:none;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(123,97,255,0.14)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
  .toggle-dark{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:#fff;cursor:pointer}

  /* filters */
  .filters{display:flex;gap:12px;margin-bottom:20px;align-items:center;flex-wrap:wrap}
  .select{background:rgba(255,255,255,0.03);border-radius:10px;padding:8px 10px;color:#fff;border:none;outline:none}
  .chips{display:flex;gap:8px;flex-wrap:wrap}

  /* grid */
  .grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px}
  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.04);backdrop-filter: blur(6px);
    transition: transform .18s ease, box-shadow .18s;
  }
  .card:hover{transform: translateY(-6px);box-shadow:0 20px 40px rgba(3,6,14,0.45)}
  .card .top{display:flex;gap:12px;align-items:center}
  .icon {width:64px;height:64px;border-radius:12px;flex-shrink:0;background:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .icon img{width:100%;height:100%;object-fit:cover}
  .meta h3{margin:0;color:#fff;font-size:16px}
  .meta p{margin:4px 0 0 0;color:var(--muted);font-size:13px}
  .rating {margin-top:8px;display:flex;align-items:center;gap:8px}
  .stars{color:#ffd95b;font-size:14px}
  .download{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .download .left{color:var(--muted);font-size:13px}
  .fav {background:transparent;border:none;color:#ff7ab6;cursor:pointer;font-size:18px}

  /* upload card */
  .upload-container{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.05);margin-bottom:22px}
  .upload-container input, .upload-container textarea, .upload-container select {width:100%;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#fff;margin-top:8px;outline:none}
  .progress {height:8px;background:rgba(255,255,255,0.05);border-radius:8px;margin-top:10px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2));width:0%}
  .small{font-size:12px;color:var(--muted)}

  /* modal */
  .modal {position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,12,0.6), rgba(2,6,12,0.85));z-index:60;padding:20px}
  .modal.show{display:flex}
  .modal-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));width:100%;max-width:900px;border-radius:12px;padding:18px;color:#fff;box-shadow:0 20px 50px rgba(0,0,0,0.7)}
  .modal-grid{display:grid;grid-template-columns:360px 1fr;gap:14px}
  .screens {display:flex;gap:8px;overflow:auto;padding-bottom:8px}
  .screens img{width:150px;height:280px;object-fit:cover;border-radius:8px}
  .details h2{margin:0 0 8px 0}
  .reviews {margin-top:12px}
  .review {background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-top:8px}
  .close-btn{float:right;background:transparent;border:none;color:#fff;font-size:20px;cursor:pointer}

  /* toast */
  .toast {position:fixed;right:20px;bottom:20px;background:#0b1220;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.5);display:none;z-index:90}
  .toast.show{display:block;animation: pop .18s ease}
  @keyframes pop{from{transform:translateY(8px);opacity:0}to{transform:none;opacity:1}}

  /* responsive */
  @media (max-width:760px){
    .modal-grid{grid-template-columns:1fr}
    .screens img{width:120px;height:200px}
    .brand h1{font-size:16px}
    .search-wrap input{width:120px}
  }

  /* dark toggle style */
  .dark .card, .dark .upload-container, .dark .modal-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
</style>
</head>
<body>
  <div class="app">
    <header class="site-header">
      <div class="brand">
        <div class="logo">SA</div>
        <div>
          <h1>Saksham App Store</h1>
          <p>Futuristic open app platform — upload & discover apps</p>
        </div>
      </div>

      <div class="actions">
        <div class="search-wrap" title="Search apps by name">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.9"><path d="M21 21l-4.35-4.35" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#fff" stroke-width="1.6"/></svg>
          <input id="searchInput" placeholder="Search apps..." />
        </div>

        <select id="categorySelect" class="select" title="Filter by category">
          <option value="">All categories</option>
        </select>

        <select id="sortSelect" class="select" title="Sort apps">
          <option value="newest">Newest</option>
          <option value="trending">Trending</option>
          <option value="topRated">Top Rated</option>
        </select>

        <button class="btn" id="uploadToggle">Upload App</button>
        <button class="toggle-dark" id="darkToggle">Dark</button>
      </div>
    </header>

    <!-- upload area (toggleable) -->
    <section id="uploadArea" style="display:none;margin-bottom:20px">
      <div class="upload-container">
        <h3 style="margin:0 0 8px 0">Upload an App (public)</h3>
        <div class="small">Anyone can upload. APKs and screenshots are stored in Firebase Storage.</div>

        <input id="appName" placeholder="App name *" />
        <input id="version" placeholder="Version (e.g., 1.0.0) *" />
        <input id="category" placeholder="Category (e.g., Games, Tools)" />
        <textarea id="description" rows="3" placeholder="Short description"></textarea>

        <label class="small" style="margin-top:8px">APK file *</label>
        <input id="apkFile" type="file" accept=".apk,.aab" />

        <label class="small" style="margin-top:8px">Icon (optional)</label>
        <input id="iconFile" type="file" accept="image/*" />

        <label class="small" style="margin-top:8px">Screenshots (optional — multiple)</label>
        <input id="screenshots" type="file" accept="image/*" multiple />

        <input id="developerName" placeholder="Developer name (optional)" />

        <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
          <button class="btn" id="startUpload">Start Upload</button>
          <div class="small" id="uploadState">No upload in progress</div>
        </div>

        <div class="progress" style="margin-top:10px"><i id="progressBar"></i></div>
      </div>
    </section>

    <!-- filter chips (category tags) -->
    <section class="filters">
      <div class="chips" id="categoryChips"></div>
    </section>

    <!-- grid of apps -->
    <section class="grid" id="grid"></section>

    <!-- modal detail -->
    <div class="modal" id="modal">
      <div class="modal-card">
        <button class="close-btn" id="closeModal">✕</button>
        <div class="modal-grid">
          <div>
            <div id="modalScreens" class="screens"></div>
            <div style="margin-top:10px">
              <img id="modalIcon" src="" style="width:120px;height:120px;border-radius:16px;object-fit:cover" />
            </div>
          </div>
          <div class="details">
            <h2 id="modalTitle"></h2>
            <div class="small" id="modalMeta"></div>
            <p id="modalDesc" style="margin-top:10px"></p>

            <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
              <button class="btn" id="downloadBtn">⬇ Download</button>
              <div style="color:var(--muted)" id="downloadCount">0 downloads</div>
              <div style="flex:1"></div>
              <div id="starBox">
                <input type="number" id="ratingInput" min="1" max="5" placeholder="Rate 1-5" style="width:90px;padding:6px;border-radius:8px;border:none" />
                <button class="btn ghost" id="submitReview">Submit Review</button>
              </div>
            </div>

            <div class="reviews" id="reviewsArea">
              <h4 style="margin-top:14px">Reviews</h4>
              <div id="reviewsList"></div>
              <textarea id="reviewText" rows="3" placeholder="Write a review (optional)" style="width:100%;margin-top:8px;background:transparent;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.04);color:#fff"></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, where, doc,
    getDocs, runTransaction, updateDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

  // ---------- CONFIG: your Firebase project (replace if needed) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBSqIqhKAyRz0aTghiKs4exajVXXExN-kA",
    authDomain: "saksham-appstore-8a2bc.firebaseapp.com",
    projectId: "saksham-appstore-8a2bc",
    storageBucket: "saksham-appstore-8a2bc.firebasestorage.app",
    messagingSenderId: "864411399391",
    appId: "1:864411399391:web:5d33d77205f9e12eff656a",
    measurementId: "G-DM2VGMNMD2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ---------- UI helpers ----------
  const $ = (id) => document.getElementById(id);
  function toast(msg, time=3000){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), time); }

  // DOM nodes
  const grid = $('grid');
  const searchInput = $('searchInput');
  const categorySelect = $('categorySelect');
  const categoryChips = $('categoryChips');
  const sortSelect = $('sortSelect');
  const uploadToggle = $('uploadToggle');
  const uploadArea = $('uploadArea');
  const startUpload = $('startUpload');
  const progressBar = $('progressBar');
  const uploadState = $('uploadState');

  // modal nodes
  const modal = $('modal');
  const closeModal = $('closeModal');
  const modalTitle = $('modalTitle');
  const modalDesc = $('modalDesc');
  const modalScreens = $('modalScreens');
  const modalIcon = $('modalIcon');
  const downloadBtn = $('downloadBtn');
  const downloadCount = $('downloadCount');
  const reviewsList = $('reviewsList');
  const reviewText = $('reviewText');
  const ratingInput = $('ratingInput');
  const submitReview = $('submitReview');

  // upload inputs
  const appNameInput = $('appName');
  const versionInput = $('version');
  const descriptionInput = $('description');
  const apkFileInput = $('apkFile');
  const iconFileInput = $('iconFile');
  const screenshotsInput = $('screenshots');
  const developerNameInput = $('developerName');

  // state
  let allApps = []; // cached snapshot
  let categories = new Set();
  let currentApp = null;

  // show/hide upload area
  uploadToggle.addEventListener('click', ()=> {
    uploadArea.style.display = uploadArea.style.display === 'none' ? 'block' : 'none';
    uploadToggle.textContent = uploadArea.style.display === 'none' ? 'Upload App' : 'Close';
  });

  // ---------- REALTIME LISTENER: apps collection ----------
  const appsRef = collection(db, 'apps');
  const appsQuery = query(appsRef, orderBy('createdAt','desc'));
  onSnapshot(appsQuery, snapshot => {
    allApps = [];
    categories.clear();
    snapshot.forEach(docSnap => {
      const data = docSnap.data(); data._id = docSnap.id;
      // ensure fields
      data.downloads = data.downloads || 0;
      data.rating = data.rating || { avg: 0, count: 0 };
      allApps.push(data);
      if (data.category) categories.add(data.category);
    });
    renderCategoryOptions();
    renderGrid();
  });

  // ---------- RENDERING ----------
  function renderCategoryOptions(){
    // populate select & chips
    const sel = categorySelect;
    const prev = sel.value;
    sel.innerHTML = '<option value="">All categories</option>';
    Array.from(categories).sort().forEach(cat=>{
      const opt = document.createElement('option'); opt.value=cat; opt.textContent=cat; sel.appendChild(opt);
    });
    if (prev) sel.value = prev;

    // chips
    categoryChips.innerHTML = '';
    Array.from(categories).slice(0,8).forEach(cat=>{
      const b = document.createElement('button');
      b.textContent = cat; b.className='btn ghost';
      b.style.padding='6px 10px'; b.style.fontSize='13px';
      b.onclick = ()=>{ categorySelect.value = cat; renderGrid(); };
      categoryChips.appendChild(b);
    });
  }

  function renderGrid(){
    const q = searchInput.value.trim().toLowerCase();
    const selectedCat = categorySelect.value;
    const sort = sortSelect.value;
    let list = allApps.slice();

    // filter by category
    if (selectedCat) list = list.filter(a => (a.category||'').toLowerCase() === selectedCat.toLowerCase());

    // search by name or description or developer
    if (q) list = list.filter(a => (a.appName||'').toLowerCase().includes(q) || (a.description||'').toLowerCase().includes(q) || (a.uploadedBy||'').toLowerCase().includes(q));

    // sort
    if (sort === 'newest') list.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    if (sort === 'trending') list.sort((a,b)=> (b.downloads||0) - (a.downloads||0));
    if (sort === 'topRated') list.sort((a,b)=> (b.rating?.avg||0) - (a.rating?.avg||0));

    // render cards
    grid.innerHTML = '';
    if (list.length === 0) {
      grid.innerHTML = '<div style="grid-column:1/-1;color:var(--muted);text-align:center;padding:30px">No apps found</div>';
      return;
    }

    list.forEach(app=>{
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="top">
          <div class="icon"><img src="${app.iconUrl || 'https://via.placeholder.com/256'}" alt="icon"/></div>
          <div style="flex:1" class="meta">
            <h3>${escapeHtml(app.appName)}</h3>
            <p>${escapeHtml(app.version || '1.0.0')} • ${escapeHtml(app.uploadedBy || 'Anonymous')}</p>
            <div class="rating"><div class="stars">${renderStars(app.rating?.avg||0)}</div><div class="small">${(app.rating?.avg||0).toFixed(1)} (${app.rating?.count||0})</div></div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
            <button class="fav" title="Favorite">♡</button>
            <div class="small">${app.downloads||0} ⬇</div>
          </div>
        </div>
        <div class="download">
          <div class="left small">${(app.description||'').slice(0,120)}</div>
          <div><button class="btn" data-id="${app._id}">Open</button></div>
        </div>
      `;
      // open modal
      card.querySelector('.btn').addEventListener('click', ()=> openModal(app._id));
      // favorite toggle
      const favBtn = card.querySelector('.fav');
      const favs = getFavs(); if (favs.includes(app._id)) favBtn.textContent='❤';
      favBtn.addEventListener('click', ()=> {
        toggleFav(app._id); favBtn.textContent = getFavs().includes(app._id) ? '❤' : '♡';
      });

      grid.appendChild(card);
    });
  }

  // Utility render stars
  function renderStars(avg){
    const full = Math.round(avg);
    let s='';
    for(let i=0;i<5;i++) s += i<full ? '★' : '☆';
    return s;
  }

  // escape html always for content inserted into innerHTML
  function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

  // ---------- FAVS ----------
  function getFavs(){ try{ return JSON.parse(localStorage.getItem('saksham_favs')||'[]') }catch(e){return []} }
  function toggleFav(id){
    const f = getFavs();
    if (f.includes(id)){ localStorage.setItem('saksham_favs', JSON.stringify(f.filter(x=>x!==id))); toast('Removed from favorites') }
    else { f.push(id); localStorage.setItem('saksham_favs', JSON.stringify(f)); toast('Added to favorites') }
  }

  // ---------- UPLOAD LOGIC ----------
  startUpload.addEventListener('click', async ()=>{
    const appName = appNameInput.value.trim();
    const version = versionInput.value.trim();
    const description = descriptionInput.value.trim();
    const category = (document.getElementById('category').value || '').trim();
    const developer = developerNameInput.value.trim() || 'Anonymous';
    const apkFile = apkFileInput.files[0];
    const iconFile = iconFileInput.files[0];
    const screenshots = Array.from(screenshotsInput.files || []);

    if (!appName || !version || !apkFile) { toast('Please fill required fields and select APK',4000); return; }

    try {
      uploadState.textContent = 'Uploading APK...';
      progressBar.style.width = '0%';

      // upload apk
      const apkPath = `public_apks/${Date.now()}_${sanitizeFilename(apkFile.name)}`;
      const apkRef = ref(storage, apkPath);
      await uploadWithProgress(apkRef, apkFile, (p)=> { progressBar.style.width = p + '%'; });
      const apkUrl = await getDownloadURL(apkRef);

      // icon
      let iconUrl = '';
      if (iconFile) {
        const iconPath = `public_icons/${Date.now()}_${sanitizeFilename(iconFile.name)}`;
        const iconRef = ref(storage, iconPath);
        await uploadWithProgress(iconRef, iconFile, (p)=> { /* small progress */ });
        iconUrl = await getDownloadURL(iconRef);
      }

      // screenshots
      const screenshotsUrls = [];
      for (let i=0;i<screenshots.length;i++){
        const s = screenshots[i];
        const sPath = `public_screenshots/${Date.now()}_${i}_${sanitizeFilename(s.name)}`;
        const sRef = ref(storage, sPath);
        await uploadWithProgress(sRef, s, (p)=>{ /* ignore */ });
        const sUrl = await getDownloadURL(sRef);
        screenshotsUrls.push(sUrl);
      }

      // save doc (published instantly)
      const doc = {
        appName, version, description, category, apkUrl, iconUrl, screenshots: screenshotsUrls,
        uploadedBy: developer, createdAt: serverTimestamp(), downloads: 0, rating: { avg: 0, count: 0 }, versions: [{version, createdAt: serverTimestamp()}]
      };
      const added = await addDoc(collection(db,'apps'), doc);

      // ensure category appears
      if (category) categories.add(category); renderCategoryOptions();

      // done
      progressBar.style.width = '100%';
      uploadState.textContent = 'Upload finished';
      toast('App uploaded and live!');

      // clear
      appNameInput.value='';versionInput.value='';descriptionInput.value='';apkFileInput.value='';iconFileInput.value='';screenshotsInput.value='';developerNameInput.value='';

    } catch (err){
      console.error(err);
      toast('Upload failed: ' + (err.message || err), 5000);
      uploadState.textContent = 'Upload failed';
    }
  });

  // helper: upload with progress (resumable)
  function uploadWithProgress(storageRef, file, onProgress){
    return new Promise((resolve,reject)=>{
      const task = uploadBytesResumable(storageRef, file);
      task.on('state_changed', snapshot => {
        const percent = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
        if (onProgress) onProgress(percent);
      }, reject, ()=> resolve());
    });
  }

  // sanitize file names
  function sanitizeFilename(n){ return n.replaceAll(/[^a-zA-Z0-9.\-_]/g,'_'); }

  // ---------- MODAL & DETAILS ----------
  async function openModal(appId){
    // find doc
    const appDoc = allApps.find(a=>a._id===appId);
    if(!appDoc) return;
    currentApp = appDoc;
    modalTitle.textContent = appDoc.appName;
    modalDesc.textContent = appDoc.description || '';
    modalIcon.src = appDoc.iconUrl || 'https://via.placeholder.com/256';
    modalScreens.innerHTML = '';
    (appDoc.screenshots||[]).forEach(url=>{
      const img = document.createElement('img'); img.src=url; modalScreens.appendChild(img);
    });
    downloadCount.textContent = (appDoc.downloads||0) + ' downloads';

    // load reviews
    reviewsList.innerHTML = 'Loading reviews...';
    const reviewsSnapshot = await getDocs(collection(db, 'apps', appId, 'reviews'));
    const reviews = [];
    reviewsSnapshot.forEach(s=> reviews.push(s.data()));
    if (reviews.length===0) reviewsList.innerHTML = '<div class="small">No reviews yet — be first!</div>';
    else {
      reviewsList.innerHTML = '';
      reviews.forEach(r=>{
        const div = document.createElement('div'); div.className='review';
        div.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${escapeHtml(r.name||'Anonymous')}</strong><div class="small">${r.rating}★</div></div><div style="margin-top:6px">${escapeHtml(r.text||'')}</div>`;
        reviewsList.appendChild(div);
      });
    }

    // show modal
    modal.classList.add('show');

    // set download handler
    downloadBtn.onclick = ()=> handleDownload(appId, appDoc.apkUrl);
    // submit review handler
    submitReview.onclick = ()=> submitReviewForApp(appId);
  }

  closeModal.addEventListener('click', ()=> modal.classList.remove('show'));

  // download increments downloads count then opens url
  async function handleDownload(appId, url){
    try {
      // transaction increment
      const appRef = doc(db,'apps', appId);
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(appRef);
        const cur = snap.data().downloads || 0;
        tx.update(appRef, { downloads: cur + 1 });
      });
    } catch(e){ console.warn('Counting download failed', e); }
    // open link
    window.open(url, '_blank');
    toast('Download started');
  }

  // submit review
  async function submitReviewForApp(appId){
    const rating = Number(ratingInput.value);
    const text = reviewText.value.trim();
    if (!rating || rating<1 || rating>5) { toast('Enter a rating 1-5'); return; }

    try {
      // add review doc
      await addDoc(collection(db, 'apps', appId, 'reviews'), { rating, text, name: 'Anonymous', createdAt: serverTimestamp() });

      // update aggregated rating atomically
      const appRef = doc(db,'apps',appId);
      await runTransaction(db, async tx=>{
        const snap = await tx.get(appRef);
        if (!snap.exists()) throw "App missing";
        const data = snap.data();
        const old = data.rating || { avg:0, count:0 };
        const newCount = (old.count||0) + 1;
        const newAvg = ((old.avg||0)*(old.count||0) + rating) / newCount;
        tx.update(appRef, { rating: { avg: newAvg, count: newCount }});
      });

      ratingInput.value=''; reviewText.value='';
      toast('Review submitted — thanks!');
      // refresh snapshot UI will auto-update because onSnapshot listens to apps collection
    } catch (err){
      console.error(err);
      toast('Failed to submit review: ' + err.message);
    }
  }

  // ---------- simple search/sort listeners ----------
  searchInput.addEventListener('input', ()=> renderGrid());
  categorySelect.addEventListener('change', ()=> renderGrid());
  sortSelect.addEventListener('change', ()=> renderGrid());

  // ---------- small helpers ----------
  function sanitizeFilename(name){ return name.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9._-]/g,''); }

  function escapeHtml(str){ return String(str||'').replace(/&/g, '&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // dark mode toggle
  const darkToggle = $('darkToggle');
  darkToggle.addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    darkToggle.textContent = document.body.classList.contains('dark') ? 'Light' : 'Dark';
  });

  // initial favorites from localStorage: mark if exists (renderGrid handles icons)
  // toast example
  function toastShort(m){ toast(m,3000) }

  // helper getDocs imported earlier is used in reviews; ensure available
</script>
</body>
</html>
