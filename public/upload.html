<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload App ‚Äî Saksham App Store</title>
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js" type="module"></script>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="nav-left"><h2>Saksham App Store</h2></div>
    <div class="nav-right">
      <a href="index.html" class="nav-link">Home</a>
      <a href="upload.html" class="nav-link active">Upload App</a>
      <a href="login.html" class="nav-link">Developers</a>
      <a href="admin.html" class="nav-link">Admin</a>
    </div>
  </nav>

  <!-- UPLOAD FORM -->
  <main>
    <div class="upload-container">
      <h1>Upload Your APK</h1>
      <input type="text" id="appName" placeholder="App Name" required />
      <input type="text" id="version" placeholder="Version (e.g., 1.0.0)" required />
      <textarea id="description" placeholder="Description"></textarea>
      <input type="file" id="apkFile" accept=".apk" required />
      <input type="file" id="iconFile" accept="image/*" />
      <button id="uploadBtn">Upload App</button>
      <p id="statusMsg"></p>
    </div>
  </main>

  <footer>
    <p>¬© 2025 Saksham App Store</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    // üî• Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBSqIqhKAyRz0aTghiKs4exajVXXExN-kA",
      authDomain: "saksham-appstore-8a2bc.firebaseapp.com",
      projectId: "saksham-appstore-8a2bc",
      storageBucket: "saksham-appstore-8a2bc.firebasestorage.app",
      messagingSenderId: "864411399391",
      appId: "1:864411399391:web:5d33d77205f9e12eff656a",
      measurementId: "G-DM2VGMNMD2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    const appNameInput = document.getElementById("appName");
    const versionInput = document.getElementById("version");
    const descriptionInput = document.getElementById("description");
    const apkFileInput = document.getElementById("apkFile");
    const iconFileInput = document.getElementById("iconFile");
    const uploadBtn = document.getElementById("uploadBtn");
    const statusMsg = document.getElementById("statusMsg");

    let currentUserEmail = null;

    // ‚ö° Ensure developer is logged in
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("Please log in first!");
        window.location.href = "login.html";
      } else {
        currentUserEmail = user.email;
      }
    });

    // üì¶ Upload APK
    uploadBtn.addEventListener("click", async () => {
      const appName = appNameInput.value.trim();
      const version = versionInput.value.trim();
      const description = descriptionInput.value.trim();
      const apkFile = apkFileInput.files[0];
      const iconFile = iconFileInput.files[0];

      if (!appName || !version || !apkFile) {
        alert("Please fill in all required fields and select APK file.");
        return;
      }

      statusMsg.textContent = "Uploading APK...";
      try {
        // Upload APK to Firebase Storage
        const apkRef = ref(storage, `apks/${Date.now()}_${apkFile.name}`);
        await uploadBytes(apkRef, apkFile);
        const apkUrl = await getDownloadURL(apkRef);

        let iconUrl = "";
        if (iconFile) {
          const iconRef = ref(storage, `icons/${Date.now()}_${iconFile.name}`);
          await uploadBytes(iconRef, iconFile);
          iconUrl = await getDownloadURL(iconRef);
        }

        // Save app info to Firestore
        await addDoc(collection(db, "apps"), {
          appName,
          version,
          description,
          apkUrl,
          iconUrl,
          uploadedBy: currentUserEmail,
          status: "pending",
          createdAt: serverTimestamp()
        });

        statusMsg.textContent = "‚úÖ App uploaded successfully! Pending admin approval.";
        appNameInput.value = "";
        versionInput.value = "";
        descriptionInput.value = "";
        apkFileInput.value = "";
        iconFileInput.value = "";

      } catch (error) {
        console.error(error);
        statusMsg.textContent = "‚ùå Upload failed: " + error.message;
      }
    });
  </script>
</body>
</html>
